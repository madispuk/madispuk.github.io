<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liivalaia eskiis 27.09.2022</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
      #map {
        height: 65vh;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto">
      <!-- Add select input here -->
      <div id="controls" class="flex justify-center p-4">
        <select id="image-select" class="w-full md:w-1/4 bg-white p-2 rounded-lg shadow-lg border border-gray-300">
          <option value="liivalaia-200-no-alpha.png">Liivalaia (27.09.2022)</option>
          <option value="kohalik-1.png">Koidu (Kohalik 1)</option>
        </select>
      </div>

      <div id="map" class="rounded shadow-lg border border-gray-300"></div>

      <div
        id="controls"
        class="flex flex-col md:flex-row justify-center items-center mt-4 space-y-4 md:space-y-0 md:space-x-4"
      >
        <div class="slider-group w-full md:w-1/2 bg-white p-4 rounded-lg shadow-lg border border-gray-300">
          <label class="block text-sm font-semibold mb-2 text-center"
            >Overlay Opacity: <span id="opacity-display" class="font-bold text-indigo-600">0.6</span></label
          >
          <input
            type="range"
            id="opacity"
            min="0"
            max="1"
            step="0.01"
            value="0.33"
            class="w-full h-2 bg-indigo-300 rounded-lg appearance-none cursor-pointer"
          />
        </div>
        <button id="toggle-opacity" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700">
          Toggle Overlay
        </button>
      </div>
    </div>

    <!-- Load Leaflet -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Load proj4 before proj4leaflet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

    <script>
      // Initialize the custom projection using Proj4Leaflet
      var crs = new L.Proj.CRS(
        "EPSG:3301",
        "+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",
        {
          resolutions: [2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5, 0.25, 0.125, 0.0625],
        },
      );

      // Initialize the map with the custom CRS and center on Liivalaia Street
      var map = L.map("map", {
        crs: crs,
        center: L.latLng((59.435725 + 59.424995) / 2, (24.72035 + 24.765921) / 2), // Center of imageBounds
        zoom: 10, // Zoom level for detailed view
      });

      // Add the Orthophoto WMS layer as the base layer
      var ortoBaseLayer = L.tileLayer
        .wms("https://kaart.maaamet.ee/wms/alus?", {
          layers: "of10000",
          format: "image/png",
          transparent: false, // As it's the base layer, no need for transparency
        })
        .addTo(map);

      // Predefined image overlays with their corresponding bounds
      var imageOverlays = {
        "liivalaia-200-no-alpha.png": {
          bounds: [
            [59.435725, 24.72035], // Upper-left corner (latitude, longitude)
            [59.424995, 24.765921], // Lower-right corner (latitude, longitude)
          ],
        },
        "kohalik-1.png": {
          bounds: [
            [59.43014949, 24.72852105], // Upper-left corner (latitude, longitude)
            [59.4266733, 24.7350316], // Lower-right corner (latitude, longitude)
          ],
        },
      };

      // Current image overlay
      var imageOverlay = L.imageOverlay(
        "liivalaia-200-no-alpha.png",
        imageOverlays["liivalaia-200-no-alpha.png"].bounds,
        {
          opacity: 0.6,
          interactive: true,
        },
      ).addTo(map);

      // Function to update the overlay opacity dynamically
      function updateOverlayOpacity() {
        var opacity = parseFloat(document.getElementById("opacity").value);

        // Update the display of opacity value
        document.getElementById("opacity-display").innerText = opacity.toFixed(2);

        // Update the overlay opacity
        imageOverlay.setOpacity(opacity);
      }

      // Function to toggle the overlay opacity between 0 and 1
      function toggleOverlayOpacity() {
        var currentOpacity = imageOverlay.options.opacity;
        var newOpacity = currentOpacity === 1 ? 0 : 1;

        // Update the overlay opacity
        imageOverlay.setOpacity(newOpacity);

        // Update the slider and display to reflect the new opacity
        document.getElementById("opacity").value = newOpacity;
        document.getElementById("opacity-display").innerText = newOpacity.toFixed(2);
      }

      // Function to update image overlay based on selection
      function updateImageOverlay() {
        var selectedImageUrl = document.getElementById("image-select").value;
        var bounds = imageOverlays[selectedImageUrl].bounds;

        // Remove the current overlay
        map.removeLayer(imageOverlay);

        // Add the new overlay
        imageOverlay = L.imageOverlay(selectedImageUrl, bounds, {
          opacity: parseFloat(document.getElementById("opacity").value),
          interactive: true,
        }).addTo(map);

        // Fit the map to the new image bounds
        map.fitBounds(bounds);
      }

      // Attach event listener to the toggle button
      document.getElementById("toggle-opacity").addEventListener("click", toggleOverlayOpacity);
      // Attach event listeners to sliders
      document.getElementById("opacity").addEventListener("input", updateOverlayOpacity);
      // Attach event listener to the image select dropdown
      document.getElementById("image-select").addEventListener("change", updateImageOverlay);
    </script>
  </body>
</html>
